<section class="pt-16 fade-in min-h-screen flex flex-col justify-between">
  <div class="mb-20 h-full max-w-7xl mx-auto text-center">
    <h2 class="text-3xl font-bold mb-8">Ministries</h2>

    <% if session[:user_id] %>
      <% user = User.find_by(id: session[:user_id]) %>
      <% if user&.admin? %>
        <%= link_to 'Create a new Ministry +', new_ministry_path, class: "bg-blue-500 cursor-pointer hover:bg-blue-700 text-white font-bold py-3 px-5 rounded focus:outline-none focus:shadow-outline" %>
      <% end %>
    <% end %> 

    <div id="ministries-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mt-8" data-admin="<%= user&.admin? ? 'true' : 'false' %>">
      <% @ministries.reverse.each do |ministry| %>
        <div class="ministry-item bg-gray-200 mx-auto p-4 transition duration-200 w-80 ease-in-out rounded-xl cursor-pointer open-modal fade-in" data-modal="modal-<%= ministry.id %>" data-id="<%= ministry.id %>">
          <% if ministry.image.attached? %>
            <%= image_tag ministry.image, class: "h-56 w-80 object-cover rounded-xl", alt: ministry.name %>
          <% else %>
            <%= image_tag('default-image.png', class: "h-56 w-80 object-cover rounded-xl", alt: ministry.name) %>
          <% end %>

          <p class="my-2 font-semibold text-lg text-center"><%= ministry.name %></p>
        </div>
      
        <!-- Modal for this ministry -->
        <div id="modal-<%= ministry.id %>" class="modal invisible z-100">
          <div class="modal-content flex flex-col relative">
            <span class="modal-close absolute top-4 right-4 cursor-pointer text-2xl hover:text-red-500 mr-2">×</span>
        
            <div class='mt-5'>
                <h2 class="text-2xl font-bold"><%= ministry.name %></h2>
                <p class="mt-3" style="line-height: 1.6; font-size: 18px; text-align: left;"><%= simple_format(ministry.description) %></p>
                <h4 class="text-xl font-bold mt-6">Schedule</h4>
                <div class="mt-3" style="line-height: 1.6; font-size: 18px; text-align: left;"><%= simple_format(ministry.schedule) %></div>
            </div>

        
            <% if user&.admin? %>
              <div class="mt-6 flex justify-center mx-auto">
                <%= link_to 'Edit', edit_ministry_path(ministry), class: 'bg-blue-500 text-white px-4 py-2 rounded-lg mr-2' %>
                <%= button_to 'Delete', ministry_path(ministry), method: :delete, data: { confirm: 'Are you sure you want to delete this ministry?' }, class: 'bg-red-500 text-white px-4 py-2 rounded-lg' %>
              </div>
            <% end %>
          </div>
        </div>        
      <% end %>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const isAdmin = document.getElementById('ministries-list').getAttribute('data-admin') === 'true';

    // Открытие модального окна
    const openModals = document.querySelectorAll('.open-modal');
    openModals.forEach(modal => {
        modal.addEventListener('click', function () {
            const modalId = this.getAttribute('data-modal');
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.classList.remove('invisible'); 
                document.body.style.overflow = 'hidden'; 
                document.documentElement.style.overflow = 'hidden';
                const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
                document.body.style.paddingRight = `${scrollBarWidth}px`;
            } else {
                console.error('Modal not found:', modalId);
            }
        });
    });

    // Закрытие модального окна
    const closeModalElements = document.querySelectorAll('.modal-close');
    closeModalElements.forEach(closeBtn => {
        closeBtn.addEventListener('click', function () {
            this.closest('.modal').classList.add('invisible'); 
            document.body.style.overflow = ''; 
            document.documentElement.style.overflow = ''; 
            document.body.style.paddingRight = ''; 
        });
    });

    // Закрытие модального окна по клику вне контента модалки
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('click', function (event) {
            if (event.target === this) {
                this.classList.add('invisible'); 
                document.body.style.overflow = ''; 
                document.documentElement.style.overflow = ''; 
                document.body.style.paddingRight = ''; 
            }
        });
    });

    // Плавное открытие элементов (если есть анимация)
    const ministries = document.querySelectorAll('.ministry-item');
    ministries.forEach((ministry, index) => {
        setTimeout(() => {
            ministry.classList.add('fade-in');
        }, index * 100);
    });

    // Динамическое изменение размера модального окна при изменении размеров окна браузера
    window.addEventListener('resize', function() {
        const activeModals = document.querySelectorAll('.modal:not(.invisible)');
        activeModals.forEach(modal => {
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.maxHeight = `${window.innerHeight * 0.8}px`;
        });
    });
});
</script>

<style>
    .fade-in {
        opacity: 0;
        animation: fadeIn 0.6s forwards;
    }

    @keyframes fadeIn {
        to {
            opacity: 1;
        }
    }

    .modal {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); 
        backdrop-filter: blur(1px); 
        z-index: 99999999; 
        overflow-y: auto; 
    }

    .modal-content {
        margin: auto;
        justify-content: center;
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        position: relative;
        width: 80%;
        max-width: 700px;
        z-index: 1001;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 24px;
    }

    .invisible {
        display: none;
    }

    .ministry-item {
        cursor: pointer;
        transition: transform 0.2s ease-in-out;
    }

    .ministry-item:hover {
        transform: scale(1.05);
    }

    .modal-content p, .modal-content div {
        text-align: left;
        word-wrap: break-word;
    }
</style>